<!DOCTYPE html>
<html>
<head>
    <title>Debug All XMP Fields</title>
    <script src="https://unpkg.com/exifr@7.1.3/dist/lite.umd.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .xmp-section { background: #f0f8ff; padding: 10px; margin: 10px 0; border-left: 4px solid #0066cc; }
        .dji-section { background: #fff3cd; padding: 10px; margin: 10px 0; border-left: 4px solid #ffc107; }
        .rtk-section { background: #d4edda; padding: 10px; margin: 10px 0; border-left: 4px solid #28a745; }
        .field-item { margin: 3px 0; font-family: monospace; font-size: 12px; }
        .field-name { color: #0066cc; font-weight: bold; }
        .field-value { color: #333; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Debug All XMP Fields</h1>
    <p>This tool shows ALL XMP fields found in the images to help identify the correct RTK field names.</p>
    
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.tif,.tiff,.png,.dng,.raw,.cr2,.nef,.arw,.orf,.rw2,.pef,.srw">
    <button onclick="analyzeXMPFields()">Analyze XMP Fields</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>

    <script>
        async function analyzeXMPFields() {
            const files = document.getElementById('file-input').files;
            const resultsDiv = document.getElementById('results');
            
            if (files.length === 0) {
                alert('Please select some images to process');
                return;
            }

            resultsDiv.innerHTML = '<h2>Analyzing XMP fields...</h2>';

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const exifData = await exifr.parse(arrayBuffer, { 
                        gps: true,
                        xmp: true
                    });
                    
                    displayAllXMPFields(file.name, exifData);
                } catch (error) {
                    resultsDiv.innerHTML += `
                        <div class="result">
                            <h3>${file.name}</h3>
                            <p style="color: red;">Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function displayAllXMPFields(filename, exifData) {
            const resultsDiv = document.getElementById('results');
            
            // Separate fields by category
            const xmpFields = {};
            const djiFields = {};
            const rtkFields = {};
            const allFields = {};

            // Get all fields
            for (const [key, value] of Object.entries(exifData || {})) {
                allFields[key] = value;
                
                // XMP fields
                if (key.startsWith('Xmp.')) {
                    xmpFields[key] = value;
                    
                    // DJI-related fields
                    if (key.toLowerCase().includes('dji') || 
                        key.toLowerCase().includes('drone') ||
                        key.toLowerCase().includes('selfdata') ||
                        key.toLowerCase().includes('zenmuse')) {
                        djiFields[key] = value;
                    }
                    
                    // RTK-related fields
                    if (key.toLowerCase().includes('rtk') ||
                        key.toLowerCase().includes('accuracy') ||
                        key.toLowerCase().includes('differential') ||
                        key.toLowerCase().includes('correction') ||
                        key.toLowerCase().includes('std')) {
                        rtkFields[key] = value;
                    }
                }
            }

            let html = `
                <div class="result">
                    <h3>${filename}</h3>
                    <p><strong>Camera:</strong> ${exifData?.Make || 'N/A'} ${exifData?.Model || 'N/A'}</p>
                    <p><strong>Total fields:</strong> ${Object.keys(allFields).length}</p>
                    <p><strong>XMP fields:</strong> ${Object.keys(xmpFields).length}</p>
            `;

            // Show RTK-related fields
            if (Object.keys(rtkFields).length > 0) {
                html += `
                    <div class="rtk-section">
                        <h4>üéØ RTK-Related XMP Fields (${Object.keys(rtkFields).length} found):</h4>`;
                for (const [key, value] of Object.entries(rtkFields)) {
                    html += `<div class="field-item">
                        <span class="field-name">${key}</span>: <span class="field-value">${value}</span>
                    </div>`;
                }
                html += `</div>`;
            } else {
                html += `
                    <div class="rtk-section">
                        <h4>‚ùå No RTK-Related XMP Fields Found</h4>
                    </div>`;
            }

            // Show DJI-related fields
            if (Object.keys(djiFields).length > 0) {
                html += `
                    <div class="dji-section">
                        <h4>üöÅ DJI-Related XMP Fields (${Object.keys(djiFields).length} found):</h4>`;
                for (const [key, value] of Object.entries(djiFields)) {
                    html += `<div class="field-item">
                        <span class="field-name">${key}</span>: <span class="field-value">${value}</span>
                    </div>`;
                }
                html += `</div>`;
            } else {
                html += `
                    <div class="dji-section">
                        <h4>‚ùå No DJI-Related XMP Fields Found</h4>
                    </div>`;
            }

            // Show all XMP fields (first 20 for brevity)
            if (Object.keys(xmpFields).length > 0) {
                const sortedKeys = Object.keys(xmpFields).sort();
                const fieldsToShow = sortedKeys.slice(0, 20);
                
                html += `
                    <div class="xmp-section">
                        <h4>üìã All XMP Fields (showing first 20 of ${sortedKeys.length}):</h4>`;
                for (const key of fieldsToShow) {
                    html += `<div class="field-item">
                        <span class="field-name">${key}</span>: <span class="field-value">${xmpFields[key]}</span>
                    </div>`;
                }
                
                if (sortedKeys.length > 20) {
                    html += `<div class="field-item" style="color: #666; font-style: italic;">
                        ... and ${sortedKeys.length - 20} more fields
                    </div>`;
                }
                
                html += `</div>`;
            }

            html += `</div>`;
            resultsDiv.innerHTML += html;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
