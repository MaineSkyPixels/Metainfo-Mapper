<!DOCTYPE html>
<html>
<head>
    <title>Search for RTK Fields</title>
    <script src="https://unpkg.com/exifr@7.1.3/dist/lite.umd.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .search-term { background: #fff3cd; padding: 5px; margin: 5px; border-radius: 3px; }
        .matches { background: #d4edda; padding: 10px; margin: 10px 0; }
        .no-matches { background: #f8d7da; padding: 10px; margin: 10px 0; }
        .field-match { font-family: monospace; font-size: 12px; margin: 2px 0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Search for RTK Fields</h1>
    <p>This tool searches for fields containing specific keywords to find RTK data.</p>
    
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.tif,.tiff,.png,.dng,.raw,.cr2,.nef,.arw,.orf,.rw2,.pef,.srw">
    <button onclick="searchRTKFields()">Search for RTK Fields</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>

    <script>
        async function searchRTKFields() {
            const files = document.getElementById('file-input').files;
            const resultsDiv = document.getElementById('results');
            
            if (files.length === 0) {
                alert('Please select some images to process');
                return;
            }

            resultsDiv.innerHTML = '<h2>Searching for RTK fields...</h2>';

            // Search terms to look for
            const searchTerms = [
                'rtk', 'RTK', 'Rtk',
                'accuracy', 'Accuracy',
                'differential', 'Differential', 'Diff',
                'correction', 'Correction',
                'std', 'Std', 'STD',
                'flag', 'Flag',
                'dji', 'DJI', 'Dji',
                'drone', 'Drone',
                'selfdata', 'SelfData',
                'zenmuse', 'Zenmuse',
                'positioning', 'Positioning',
                'precision', 'Precision'
            ];

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const exifData = await exifr.parse(arrayBuffer, { 
                        gps: true,
                        xmp: true
                    });
                    
                    searchInImage(file.name, exifData, searchTerms);
                } catch (error) {
                    resultsDiv.innerHTML += `
                        <div class="result">
                            <h3>${file.name}</h3>
                            <p style="color: red;">Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function searchInImage(filename, exifData, searchTerms) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="result">
                    <h3>${filename}</h3>
                    <p><strong>Camera:</strong> ${exifData?.Make || 'N/A'} ${exifData?.Model || 'N/A'}</p>
            `;

            // Search for each term
            for (const term of searchTerms) {
                const matches = [];
                
                for (const [key, value] of Object.entries(exifData || {})) {
                    if (key.toLowerCase().includes(term.toLowerCase())) {
                        matches.push({ key, value });
                    }
                }

                if (matches.length > 0) {
                    html += `
                        <div class="matches">
                            <div class="search-term">üîç "${term}" - ${matches.length} matches:</div>`;
                    for (const match of matches) {
                        html += `
                            <div class="field-match">
                                <strong>${match.key}</strong>: ${match.value}
                            </div>`;
                    }
                    html += `</div>`;
                }
            }

            // Check if we found any RTK-related fields
            const rtkMatches = [];
            for (const [key, value] of Object.entries(exifData || {})) {
                const keyLower = key.toLowerCase();
                if (keyLower.includes('rtk') || 
                    keyLower.includes('accuracy') || 
                    keyLower.includes('differential') ||
                    keyLower.includes('correction') ||
                    keyLower.includes('std')) {
                    rtkMatches.push({ key, value });
                }
            }

            if (rtkMatches.length > 0) {
                html += `
                    <div class="matches">
                        <h4>üéØ Potential RTK Fields Found (${rtkMatches.length}):</h4>`;
                for (const match of rtkMatches) {
                    html += `
                        <div class="field-match">
                            <strong>${match.key}</strong>: ${match.value}
                        </div>`;
                }
                html += `</div>`;
            } else {
                html += `
                    <div class="no-matches">
                        <h4>‚ùå No obvious RTK fields found</h4>
                        <p>Try checking the "All XMP Fields" debug tool to see what fields are actually present.</p>
                    </div>`;
            }

            html += `</div>`;
            resultsDiv.innerHTML += html;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
